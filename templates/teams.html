<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Carreras</title>
    <style>
        nav {
            height: 50px;
            text-align: left;
            background: dimgray;
            color: black;
            font-size: 20px;
            padding-left: 50px;
            padding-right: 50px;
            font-family: Arial,serif;
            border-bottom: chartreuse 1px solid;
        }
        body {
            background: dimgrey;
            color: honeydew;
            font-family: Roboto,sans-serif;
        }
        nav a {
            text-decoration: none;
            color: honeydew;
            padding: 20px;
        }
        nav a:hover {
            color: chartreuse;
        }
        #nav-container {
            width: 60%;
            margin: auto;
        }
        #main-container {
            width: 60%;
            margin: auto;
        }
        table {
            text-align: left;
        }
        .update-button {
            background: chartreuse;
            padding: 8px;
            border-radius: 6px;
            border-style: none;
        }
        .remove-button {
            background: orangered;
            padding: 8px;
            border-radius: 6px;
            border-style: none;
        }
        form input {
            display: block;
        }
        select {
            display: block;
        }

    </style>
</head>
<body>
    <nav>
        <div id="nav-container">
            <!-- <a href="/"><img src="./static/logo.png" id="header-logo" alt="logo"/></a> -->
            <a href="/">Pilotos</a>
            <a href="/calendar">Calendario</a>
            <a href="/teams">Equipos</a>
        </div>
    </nav>
    <div id="main-container">
        <h1>Equipos y pilotos</h1>
        <div id="table-container">
            {% if teams|length > 0 %}
            <table id="team-table">
                <tr>
                    <th>Equipo</th>
                    <th>Pilotos</th>
                    <th></th>
                    <th></th>
                </tr>
                {% for t in teams %}
                <tr id="{{ t.name }}">
                    <td>{{ t.name }}</td>
                    {% if t.driver1 and t.driver2 %}
                    <td>{{ t.driver1 }} y {{ t.driver2 }}</td>
                    {% elif t.driver1 %}
                    <td>t.driver1</td>
                    {% elif t.driver2 %}
                    <td>t.driver2</td>
                    {% else %}
                    <td>No tiene pilotos</td>
                    {% endif %}
                    <td><button class="update-button" onclick="updateTeamForm({{ t.name }})" type="button">Actualizar</button></td>
                    <td><button class="remove-button" onclick="remove({{ t.name }})" type="button">Eliminar</button></td>
                </tr>
                {% endfor %}
            </table>
        {% else %}
        <p id="no-teams-banner">No se han encontrado equipos</p>
        {% endif %}
        </div>
        <button id="insert-team-button" onclick="insertTeamForm()">Inserta un nuevo equipo</button>
        <div id="freelance-drivers-container">
            <h3>Pilotos sin equipo</h3>
            {% if freelance|length > 0 %}
            <ul id="freelance-list">
                {% for d in freelance %}
                <li id="{{ d.name }}">{{ d.name }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p id="no-freelance-banner">No hay pilotos sin equipo</p>
            {% endif %}
        </div>
        <div id="team-form-container" style="display: none">
            <form id="team-form">
                <label for="name-input">Nombre del equipo:</label>
                <input type="text" id="name-input" name="name-input">

                <label for="driver1-select">Nombre de el/la primer/a piloto:</label>
                <select id="driver1-select">
                {% if freelance|length > 0 %}
                    <option value="" selected>Selecciona un/a piloto</option>
                    {% for d in freelance %}
                    <option value="{{ d.name }}">{{ d.name }}</option>
                    {% endfor %}
                {% else %}
                <option value="">No hay pilotos</option>
                {% endif %}
                </select>
                <button type="button" id="driver1-freelance-button" style="display: none">Liberar piloto</button>

                <label for="driver2-select">Nombre de el/la segundo/a piloto:</label>
                <select id="driver2-select">
                {% if freelance|length > 0 %}
                    <option value="" selected>Selecciona un/a piloto</option>
                    {% for d in freelance %}
                    <option value="{{ d.name }}">{{ d.name }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">No hay pilotos</option>
                {% endif %}
                </select>
                <button type="button" id="driver2-freelance-button" style="display: none">Liberar piloto</button>

                <button type="button" id="insert-button" onclick="insertTeam()" disabled>Insertar</button>
                <button type="button" id="update-button" onclick="update()" disabled>Actualizar</button>
            </form>
        </div>
    </div>

    <script>
        function insertTeamForm() {
            document.getElementById("team-form-container").style.display = "block";
            document.getElementById("insert-button").disabled = false;
            document.getElementById("update-button").disabled = true;
            document.getElementById("insert-team-button").style.display = "none";
        }

        function insertTeam() {
            let tabla = document.getElementById("team-table");
            let emptyTable = false;

            if (tabla === null) {
                tabla = document.createElement("Table");
                tabla.id = "team-table";
                tabla.innerHTML = '<tr><th>Equipo</th><th>Pilotos</th><th></th><th></th></tr>';
                emptyTable = true;
            }

            const nombre = document.getElementById("name-input").value;
            const piloto1 = document.getElementById("driver1-select").value;
            const piloto2 = document.getElementById("driver2-select").value;
            const fila = document.createElement("tr");

            if (nombre === "") {
                alert("El nombre no puede estar vacio");
                return false;
            } else if (!/^[a-zA-Z]+$/.test(nombre)) {
                alert("Formato de nombre incorrecto. Utiliza caracteres alfab√©ticos.");
                return false;
            }

            let formData = new FormData();
            formData.append("name", nombre);
            if (piloto1 !== "") {
                formData.append("driver1", piloto1);
            }
            if (piloto1 !== "") {
                formData.append("driver2", piloto2);
            }
            formData.append("form", "insert");

            let str_pilotos = "";
            if (piloto1 !== "" && piloto2 === "") {
                str_pilotos = piloto1;
            } else if (piloto1 === "" && piloto2 !== "") {
                str_pilotos = piloto2;
            } else if (piloto1 !== "" && piloto2 !== "") {
                str_pilotos = piloto1 + " y " + piloto2;
            }

            fila.innerHTML =
                '<td id="' + nombre + '">' + nombre + '</td>\
                <td>' + str_pilotos + '</td>\
                <td><button class="update-button" onClick="updateTeamForm(' + nombre + ')" type="button">Actualizar</button></td>\
                <td><button class="remove-button" onClick="remove(' + nombre + ')" type="button">Eliminar</button></td>'
            ;

            tabla.appendChild(fila);

            if (emptyTable) {
                document.getElementById("no-teams-banner").remove();
                document.getElementById("table-container").appendChild(tabla);
            }

            document.getElementById("team-form-container").style.display = "none";
            document.getElementById("insert-button").disabled = true;
            document.getElementById("insert-team-button").style.display = "inline-block";
            RemoveFromList(piloto1, document.getElementById("freelance-list"));
            RemoveFromList(piloto2, document.getElementById("freelance-list"));

            let request = new XMLHttpRequest();
            request.open("POST", "/teams", true);
            request.send(formData);

            alert("Equipo insertado correctamente!");
        }

        function updateTeamForm(nombre) {
            document.getElementById("team-form-container").style.display = "block";
            document.getElementById("insert-button").disabled = true;
            document.getElementById("update-button").disabled = false;
            document.getElementById("insert-team-button").style.display = "none";
            //console.log(nombre.id);
            const fila = document.getElementById(nombre.id);
            console.log(fila);
            const pilotos = fila.getElementsByTagName("TD")[1].innerText.split(' y ');
            let piloto1, piloto2 = "";
            if(pilotos.length > 0)
                piloto1 = pilotos[0];
            if(pilotos.length > 1)
                piloto2 = pilotos[1];
            document.forms["team-form"]["name-input"].value = fila.getElementsByTagName("TD")[0].innerText;

            const sel1 = document.getElementById("driver1-select");
            const sel2 = document.getElementById("driver2-select");
            if (piloto1 !== "") {
                const d1 = document.createElement("option");
                d1.value = piloto1;
                d1.innerText = piloto1;
                d1.selected = true;
                sel1.disabled = true;
                sel1.append(d1);
                const botonFL1 = document.getElementById("driver1-freelance-button");
                botonFL1.onclick = function() {makeDriverFreelance(piloto1, 1, nombre.id)};
                botonFL1.style.display = "block";
            }

            if (piloto2 !== "") {
                const d2 = document.createElement("option");
                d2.value = piloto2;
                d2.innerText = piloto2;
                d2.selected = true;
                sel2.disabled = true;
                sel2.append(d2);
                const botonFL2 = document.getElementById("driver2-freelance-button");
                botonFL2.onclick = function() {makeDriverFreelance(piloto2, 2, nombre.id)};
                botonFL2.style.display = "block";
            }

            fila.remove();
        }

        function makeDriverFreelance(piloto, num, equipo) {
            const li = document.createElement("li");
            li.innerText = li.id = piloto;
            document.getElementById("freelance-list").appendChild(li);

            let formData = new FormData();
            if (num === 1) {
                formData.append("driver1", piloto);

                const sel = document.getElementById("driver1-select");
                for (let i = 1; i < sel.length; i++) {
                    if (sel.options[i].value === piloto) {
                        sel.options[i].remove();
                        sel.options[0].selected = true;
                        document.getElementById("driver1-freelance-button").style.display = "none";
                    }
                }
                sel.disabled = false;
                document.getElementById("driver1-freelance-button").dissabled = true;
            } else {
                formData.append("driver2", piloto);

                const sel = document.getElementById("driver2-select");
                for (let i = 1; i < sel.length; i++) {
                    if (sel.options[i].value === piloto) {
                        sel.options[i].remove();
                        sel.options[0].selected = true;
                        document.getElementById("driver2-freelance-button").style.display = "none";
                    }
                }
                sel.disabled = false;
                document.getElementById("driver2-freelance-button").dissabled = true;
            }
            formData.append("name", equipo);
            formData.append("form", "freelance");

            let request = new XMLHttpRequest();
            request.open("POST", "/teams", true);
            request.send(formData);
        }

        function update() {
            const tabla = document.getElementById("team-table");
            const fila = document.createElement("tr");
            const flList = document.getElementById("freelance-list").getElementsByTagName("li");

            let formData = new FormData();

            const nombre = document.forms["team-form"]["name-input"].value;
            const piloto1 = document.forms["team-form"]["driver1-select"].value;
            const piloto2 = document.forms["team-form"]["driver2-select"].value;

            formData.append("name", nombre);

            let str_pilotos = "";
            if (piloto1 !== "" && piloto2 !== "") {
                str_pilotos = piloto1 + " y " + piloto2;
                formData.append("driver1", piloto1);
                formData.append("driver2", piloto2);
                for(let i = 0; i < flList.length; i++) {
                    if(flList[i].innerText === piloto1 || flList[i].innerText === piloto2 ) {
                        flList[i].remove();
                    }
                }
            } else if (piloto1 === "") {
                str_pilotos = piloto2;
                formData.append("driver2", piloto2);
                for(let i = 0; i < flList.length; i++) {
                    if(flList[i].innerText === piloto2 ) {
                        flList[i].remove();
                    }
                }
            } else if (piloto2 === "") {
                str_pilotos = piloto1;
                formData.append("driver1", piloto1);
                for(let i = 0; i < flList.length; i++) {
                    if(flList[i].innerText === piloto1) {
                        flList[i].remove();
                    }
                }
            }

            fila.id = nombre;
            fila.innerHTML =
                '<td>' + nombre + '</td>\
                <td>' + str_pilotos + '</td>\
                <td><button class="update-button" onClick="updateTeamForm(' + nombre + ')" type="button">Actualizar</button></td>\
                <td><button class="remove-button" onClick="remove(' + nombre + ')" type="button">Eliminar</button></td>'
            ;

            tabla.appendChild(fila);
            document.getElementById("team-form-container").style.display = "none";

            formData.append("form", "modify");

            let request = new XMLHttpRequest();
            request.open("POST", "/teams");
            request.send(formData);

            alert("Equipo actualizado correctamente!");
        }

        function remove(name) {
            const table = document.getElementById("team-table");
            const rows = table.rows;
            let currentRow;
            let foundIt = false;

            for (let i = 1; i < (rows.length); i++) {
                currentRow = i;
                console.log((rows[i].id) + " = " + name.id);
                if (rows[i].id === name.id) {
                    foundIt = true;
                    break;
                }
            }

            if (foundIt) {
                const pilotos = rows[currentRow].getElementsByTagName("TD")[1].innerText.split(' y ');
                if (pilotos.length > 0) {
                    const fl = document.getElementById("freelance-list");
                    if (pilotos.length > 0) {
                        let li1 = document.createElement("li");
                        li1.innerText = pilotos[0];
                        li1.id = pilotos[0];
                        fl.appendChild(li1);
                        if (pilotos.length > 1) {
                            let li2 = document.createElement("li");
                            li2.innerText = pilotos[1];
                            li2.id = pilotos[1];
                            fl.appendChild(li2);
                        }
                    }
                }

                table.deleteRow(currentRow);

                let formData = new FormData();
                formData.append("name", name.id);
                formData.append("form", "remove");

                let request = new XMLHttpRequest();
                request.open("POST", "/teams");
                request.send(formData);

                if (CountRows("team-table") < 1) {
                    let banner = document.createElement("p");
                    banner.id = "no-teams-banner";
                    banner.innerText = "No se han encontrado equipos en la base de datos";

                    document.getElementById("team-table").remove();
                    document.getElementById("table-container").appendChild(banner);
                }

                alert("Piloto eliminado/a correctamente!");
            } else {
                alert("Error al eliminar el equipo");
            }
        }

        function CountRows(tableId) {
            let rowCount = 0;
            let table = document.getElementById(tableId);
            let rows = table.getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].getElementsByTagName("td").length > 0) {
                    rowCount++;
                }
            }
            return rowCount;
        }

        function RemoveFromList(element, l) {
            const elementos = document.getElementById("freelance-list").getElementsByTagName("LI");
            for (let i = 0; i < elementos.length; i++) {
                if (elementos[i].id === element) {
                    elementos[i].remove();
                    return;
                }
            }
        }
    </script>
</body>
</html>